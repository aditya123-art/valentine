<script>
    // SBJIT engineering campus backend connection
    const BACKEND_URL = "https://my-backend-tiz0.onrender.com";
    let adminLoggedIn = false;

    // User tracking system
    function generateUserId() {
        return 'USER_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Valentine's Day 2026 countdown
    function initCountdown() {
        const valentine2026 = new Date('February 14, 2026 00:00:00').getTime();
        
        function updateCountdown() {
            const now = new Date().getTime();
            const distance = valentine2026 - now;
            
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            
            document.getElementById('days').textContent = days.toString().padStart(2, '0');
            document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
            document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
            document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
            
            if (distance < 0) {
                clearInterval(countdownInterval);
                document.getElementById('countdownTimer').innerHTML = '<div style="font-size: 2rem; color: #ffb81c;">Happy Valentine\'s Day 2026 SBJIT!</div>';
            }
        }
        
        updateCountdown();
        const countdownInterval = setInterval(updateCountdown, 1000);
    }

    // Calculate love compatibility for engineering students (always returns > 50%)
    function calculateEngineeringLoveScore(userName, userBranch, crushName, crushBranch, year, lab) {
        // Create a deterministic but random-seeming score between 70% and 98%
        let hash = 0;
        const combinedString = userName + userBranch + crushName + crushBranch + year + lab;
        
        for (let i = 0; i < combinedString.length; i++) {
            hash = (hash << 5) - hash + combinedString.charCodeAt(i);
            hash |= 0; // Convert to 32bit integer
        }
        
        // Generate base score between 75 and 98 for engineering students
        let score = Math.abs(hash) % 24 + 75;
        
        // Adjust based on branch compatibility
        if (userBranch === crushBranch) score += 5; // Same branch bonus
        if ((userBranch === 'cse' && crushBranch === 'it') || (userBranch === 'it' && crushBranch === 'cse')) score += 4; // Related branches
        
        // Adjust based on lab preference
        if (lab === 'computer' || lab === 'library') score += 3; // Romantic study spots
        
        // Adjust based on year
        if (year === 'third' || year === 'fourth') score += 2; // Senior students more mature
        
        // Ensure score is between 75 and 98
        score = Math.max(75, Math.min(98, score));
        
        return score;
    }

    // Get love message based on score
    function getEngineeringLoveMessage(score) {
        if (score >= 95) {
            return "Engineering Soulmates! Perfect circuit connection!";
        } else if (score >= 85) {
            return "Optimal Engineering Match! You two could debug life together!";
        } else if (score >= 75) {
            return "Great Engineering Compatibility! Your love algorithm is efficient!";
        } else {
            return "Good Engineering Pair! Your connection has strong fundamentals!";
        }
    }

    // Get love description based on score and branches
    function getEngineeringLoveDescription(score, userBranch, crushBranch) {
        const branchNames = {
            'cse': 'Computer Science & Engineering',
            'aids': 'AIDS Engineering',
            'it': 'Information Technology',
            'aiml': 'AIML Engineering',
            'entc': 'Electronics & Telecommunication',
            'mech': 'Mechanical Engineering',
            'electrical': 'Electrical Engineering'
        };
        
        if (score >= 95) {
            return `Your compatibility is exceptional! As ${branchNames[userBranch]} and ${branchNames[crushBranch]} students, you complement each other perfectly. Many SBJIT engineering couples with scores like yours are still together years after graduation!`;
        } else if (score >= 85) {
            return `Your compatibility shows strong potential for a campus romance. ${branchNames[userBranch]} and ${branchNames[crushBranch]} make a great engineering combination. Try working on a project together!`;
        } else if (score >= 75) {
            return `You have great compatibility as engineering students. ${branchNames[userBranch]} and ${branchNames[crushBranch]} students often make great pairs. Start with a study session in the library!`;
        } else {
            return `You have a good foundation for an engineering connection. ${branchNames[userBranch]} and ${branchNames[crushBranch]} can learn a lot from each other. Join the same technical club to get to know them better!`;
        }
    }

    // Save engineering test data to backend
    async function saveEngineeringData(userName, userBranch, crushName, crushBranch, year, lab, score) {
        try {
            const response = await fetch(`${BACKEND_URL}/love-test`, {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    userName,
                    userBranch,
                    crushName,
                    crushBranch,
                    year,
                    lab,
                    score
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            // Log to console for debugging
            console.log('User test data saved to backend:', data);
            
            return data;
        } catch (error) {
            console.error('Error saving test data to backend:', error);
            // Fallback: Show success message even if backend fails
            alert('Test completed! (Note: Backend connection issue - result not saved)');
            return { success: false, error: error.message };
        }
    }

    // Save review to backend
    async function saveReview(reviewerName, reviewerBranch, rating, reviewText) {
        try {
            const response = await fetch(`${BACKEND_URL}/review`, {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    reviewerName,
                    reviewerBranch,
                    rating,
                    reviewText
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            // Update reviews display
            displayReviews();
            
            // Log to console for debugging
            console.log('User review saved to backend:', data);
            
            return data;
        } catch (error) {
            console.error('Error saving review to backend:', error);
            // Fallback: Show success message even if backend fails
            alert('Review submitted! (Note: Backend connection issue - review not saved)');
            return { success: false, error: error.message };
        }
    }

    // Fetch reviews from backend
    async function displayReviews() {
        try {
            const response = await fetch(`${BACKEND_URL}/admin/reviews`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const reviews = await response.json();
            const reviewsList = document.getElementById('reviewsList');
            reviewsList.innerHTML = '';
            
            // Show latest 10 reviews
            const recentReviews = reviews.slice(0, 10);
            
            if (recentReviews.length === 0) {
                reviewsList.innerHTML = '<div class="review-item"><div class="review-content">No reviews yet. Be the first to share your experience!</div></div>';
                return;
            }
            
            recentReviews.forEach(review => {
                const branchNames = {
                    'cse': 'CSE',
                    'aids': 'AIDS',
                    'it': 'IT',
                    'aiml': 'AIML',
                    'entc': 'ENTC',
                    'mech': 'MECH',
                    'electrical': 'ELECT'
                };
                
                // Get initials for avatar
                const initials = review.reviewerName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                
                // Create star rating display
                let stars = '';
                for (let i = 1; i <= 5; i++) {
                    if (i <= review.rating) {
                        stars += 'â˜…';
                    } else {
                        stars += 'â˜†';
                    }
                }
                
                const reviewItem = document.createElement('div');
                reviewItem.className = 'review-item';
                reviewItem.innerHTML = `
                    <div class="review-header">
                        <div class="reviewer-info">
                            <div class="reviewer-avatar">${initials}</div>
                            <div class="reviewer-details">
                                <h4>${review.reviewerName}</h4>
                                <p>${branchNames[review.reviewerBranch] || review.reviewerBranch}</p>
                            </div>
                        </div>
                        <div class="review-rating" title="${review.rating} out of 5 stars">${stars}</div>
                    </div>
                    <div class="review-content">${review.reviewText}</div>
                    <div class="review-date">${new Date(review.createdAt).toLocaleDateString()}</div>
                `;
                
                reviewsList.appendChild(reviewItem);
            });
        } catch (error) {
            console.error('Error fetching reviews from backend:', error);
            const reviewsList = document.getElementById('reviewsList');
            reviewsList.innerHTML = '<div class="review-item"><div class="review-content">Unable to load reviews. Please try again later.</div></div>';
        }
    }

    // Update admin panel with data from backend
    async function updateAdminPanel() {
        try {
            // Fetch love tests data
            const loveTestsResponse = await fetch(`${BACKEND_URL}/admin/love-tests`);
            
            if (!loveTestsResponse.ok) {
                throw new Error(`HTTP error! status: ${loveTestsResponse.status}`);
            }
            
            const loveTests = await loveTestsResponse.json();
            
            // Fetch reviews data
            const reviewsResponse = await fetch(`${BACKEND_URL}/admin/reviews`);
            
            if (!reviewsResponse.ok) {
                throw new Error(`HTTP error! status: ${reviewsResponse.status}`);
            }
            
            const reviews = await reviewsResponse.json();
            
            // Update stats
            document.getElementById('totalTests').textContent = loveTests.length;
            
            // Calculate average score
            const avgScore = loveTests.length > 0 
                ? Math.round(loveTests.reduce((sum, entry) => sum + entry.score, 0) / loveTests.length)
                : 0;
            document.getElementById('avgScore').textContent = `${avgScore}%`;
            
            // Calculate today's tests
            const today = new Date().toDateString();
            const todayTests = loveTests.filter(entry => {
                const entryDate = new Date(entry.createdAt).toDateString();
                return entryDate === today;
            }).length;
            document.getElementById('todayTests').textContent = todayTests;
            
            // Calculate unique users
            const uniqueUsers = [...new Set(loveTests.map(entry => entry.userName))].length;
            document.getElementById('totalUsers').textContent = uniqueUsers;
            
            // Calculate review stats
            document.getElementById('totalReviews').textContent = reviews.length;
            
            // Calculate average rating
            const avgRating = reviews.length > 0 
                ? (reviews.reduce((sum, entry) => sum + entry.rating, 0) / reviews.length).toFixed(1)
                : '0.0';
            document.getElementById('avgRating').textContent = avgRating;
            
            // Update love test table
            const tableBody = document.getElementById('dataTableBody');
            tableBody.innerHTML = '';
            
            loveTests.forEach(entry => {
                const branchNames = {
                    'cse': 'CSE',
                    'aids': 'AIDS',
                    'it': 'IT',
                    'aiml': 'AIML',
                    'entc': 'ENTC',
                    'mech': 'MECH',
                    'electrical': 'ELECT'
                };
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${entry._id ? entry._id.substring(0, 8) : 'N/A'}...</td>
                    <td><strong>${entry.userName}</strong></td>
                    <td>${branchNames[entry.userBranch] || entry.userBranch}</td>
                    <td><strong>${entry.crushName}</strong></td>
                    <td>${branchNames[entry.crushBranch] || entry.crushBranch}</td>
                    <td><strong style="color: #ff4d6d;">${entry.score}%</strong></td>
                    <td>${new Date(entry.createdAt).toLocaleString()}</td>
                `;
                tableBody.appendChild(row);
            });
            
            // Update reviews table
            const reviewsTableBody = document.getElementById('reviewsTableBody');
            reviewsTableBody.innerHTML = '';
            
            reviews.forEach(review => {
                const branchNames = {
                    'cse': 'CSE',
                    'aids': 'AIDS',
                    'it': 'IT',
                    'aiml': 'AIML',
                    'entc': 'ENTC',
                    'mech': 'MECH',
                    'electrical': 'ELECT'
                };
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${review._id ? review._id.substring(0, 8) : 'N/A'}...</td>
                    <td><strong>${review.reviewerName}</strong></td>
                    <td>${branchNames[review.reviewerBranch] || review.reviewerBranch}</td>
                    <td>${'â˜…'.repeat(review.rating)}${'â˜†'.repeat(5-review.rating)}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${review.reviewText}">${review.reviewText}</td>
                    <td>${new Date(review.createdAt).toLocaleString()}</td>
                `;
                reviewsTableBody.appendChild(row);
            });
        } catch (error) {
            console.error('Error fetching data for admin panel:', error);
            alert('Error loading admin data. Please check your connection.');
        }
    }

    // Initialize admin panel
    function initAdminPanel() {
        // Toggle admin panel visibility - show login modal first
        document.getElementById('adminToggle').addEventListener('click', function() {
            if (!adminLoggedIn) {
                // Show login modal
                document.getElementById('adminLoginModal').classList.add('show');
            } else {
                // Toggle admin panel
                const adminPanel = document.getElementById('adminPanel');
                const isVisible = adminPanel.classList.contains('show');
                
                if (isVisible) {
                    adminPanel.classList.remove('show');
                    this.querySelector('i').className = 'fas fa-user-shield';
                } else {
                    adminPanel.classList.add('show');
                    this.querySelector('i').className = 'fas fa-eye-slash';
                    updateAdminPanel();
                }
            }
        });
        
        // Close login modal
        document.getElementById('closeLogin').addEventListener('click', function() {
            document.getElementById('adminLoginModal').classList.remove('show');
            document.getElementById('loginError').classList.remove('show');
            document.getElementById('adminLoginForm').reset();
        });
        
        // Admin login form submission
        document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            
            try {
                const response = await fetch(`${BACKEND_URL}/admin-login`, {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json" 
                    },
                    body: JSON.stringify({ 
                        username, 
                        password 
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    adminLoggedIn = true;
                    
                    // Hide login modal
                    document.getElementById('adminLoginModal').classList.remove('show');
                    document.getElementById('loginError').classList.remove('show');
                    this.reset();
                    
                    // Show admin panel
                    document.getElementById('adminPanel').classList.add('show');
                    document.getElementById('adminToggle').querySelector('i').className = 'fas fa-eye-slash';
                    
                    // Update admin panel with data
                    updateAdminPanel();
                    
                    // Show success message
                    alert('Admin login successful!');
                } else {
                    // Show error
                    document.getElementById('loginError').textContent = data.message || 'Invalid credentials';
                    document.getElementById('loginError').classList.add('show');
                }
            } catch (error) {
                console.error('Error during admin login:', error);
                document.getElementById('loginError').textContent = 'Connection error. Please try again.';
                document.getElementById('loginError').classList.add('show');
            }
        });
        
        // Close admin panel
        document.getElementById('closeAdmin').addEventListener('click', function() {
            document.getElementById('adminPanel').classList.remove('show');
            document.getElementById('adminToggle').querySelector('i').className = 'fas fa-user-shield';
        });
        
        // Logout admin
        document.getElementById('logoutAdmin').addEventListener('click', function() {
            adminLoggedIn = false;
            document.getElementById('adminPanel').classList.remove('show');
            document.getElementById('adminToggle').querySelector('i').className = 'fas fa-user-shield';
            alert('Admin logged out successfully.');
        });
        
        // Export data
        document.getElementById('exportData').addEventListener('click', async function() {
            try {
                const response = await fetch(`${BACKEND_URL}/admin/export`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const dataStr = JSON.stringify(data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = `sbjit_valentine_data_${new Date().getTime()}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                alert('All data exported successfully!');
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Error exporting data. Please try again.');
            }
        });
        
        // Clear all data
        document.getElementById('clearData').addEventListener('click', async function() {
            if (confirm('Are you sure you want to clear ALL data? This action cannot be undone!')) {
                try {
                    const response = await fetch(`${BACKEND_URL}/admin/clear`, {
                        method: "POST",
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.success) {
                        updateAdminPanel();
                        displayReviews();
                        alert('All data has been cleared successfully!');
                    } else {
                        alert('Error clearing data: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error clearing data:', error);
                    alert('Error clearing data. Please try again.');
                }
            }
        });
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize features
        initCountdown();
        initAdminPanel();
        displayReviews();
        
        // Initialize star rating system
        const starRatings = document.querySelectorAll('.star-rating');
        const reviewRatingInput = document.getElementById('reviewRating');
        
        starRatings.forEach(star => {
            star.addEventListener('click', function() {
                const rating = parseInt(this.getAttribute('data-rating'));
                reviewRatingInput.value = rating;
                
                // Update star display
                starRatings.forEach((s, index) => {
                    if (index < rating) {
                        s.textContent = 'â˜…';
                        s.style.color = '#ffb81c';
                    } else {
                        s.textContent = 'â˜†';
                        s.style.color = '#ccc';
                    }
                });
            });
            
            // Add hover effect
            star.addEventListener('mouseover', function() {
                const rating = parseInt(this.getAttribute('data-rating'));
                starRatings.forEach((s, index) => {
                    if (index < rating) {
                        s.style.color = '#ffb81c';
                    }
                });
            });
            
            star.addEventListener('mouseout', function() {
                const currentRating = parseInt(reviewRatingInput.value);
                starRatings.forEach((s, index) => {
                    if (index >= currentRating) {
                        s.style.color = '#ccc';
                    }
                });
            });
        });
        
        // Review form submission
        document.getElementById('reviewForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const reviewerName = document.getElementById('reviewerName').value.trim();
            const reviewerBranch = document.getElementById('reviewerBranch').value;
            const rating = parseInt(document.getElementById('reviewRating').value);
            const reviewText = document.getElementById('reviewText').value.trim();
            
            // Validate inputs
            if (!reviewerName || !reviewerBranch || rating === 0 || !reviewText) {
                alert('Please fill in all fields and select a rating.');
                return;
            }
            
            if (rating < 1 || rating > 5) {
                alert('Please select a rating between 1 and 5 stars.');
                return;
            }
            
            // Save review
            await saveReview(reviewerName, reviewerBranch, rating, reviewText);
            
            // Reset form
            this.reset();
            reviewRatingInput.value = 0;
            starRatings.forEach(star => {
                star.textContent = 'â˜†';
                star.style.color = '#ccc';
            });
            
            // Show success message
            alert('Thank you for your review! Your feedback has been recorded.');
            
            // Scroll to reviews
            document.getElementById('reviewsList').scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
        
        // Scroll to calculator when CTA button is clicked
        document.getElementById('startTestBtn').addEventListener('click', function() {
            document.getElementById('calculator').scrollIntoView({ behavior: 'smooth' });
        });
        
        // Calculate love compatibility
        document.getElementById('calculateBtn').addEventListener('click', async function() {
            // Get form values
            const userName = document.getElementById('yourName').value.trim();
            const userBranch = document.getElementById('yourDepartment').value;
            const crushName = document.getElementById('crushName').value.trim();
            const crushBranch = document.getElementById('crushDepartment').value;
            const year = document.getElementById('year').value;
            const lab = document.getElementById('lab').value;
            
            // Validate inputs
            if (!userName || !userBranch || !crushName || !crushBranch) {
                alert('Please fill in all required fields: Your full name, branch, crush\'s full name, and crush\'s branch.');
                return;
            }
            
            // Calculate score (always > 50%)
            const score = calculateEngineeringLoveScore(userName, userBranch, crushName, crushBranch, year, lab);
            
            // Save engineering data to backend
            await saveEngineeringData(userName, userBranch, crushName, crushBranch, year, lab, score);
            
            // Display result
            document.getElementById('resultPercentage').textContent = `${score}%`;
            document.getElementById('resultMessage').textContent = getEngineeringLoveMessage(score);
            document.getElementById('resultDescription').textContent = getEngineeringLoveDescription(score, userBranch, crushBranch);
            
            // Show result with animation
            const resultContainer = document.getElementById('resultContainer');
            resultContainer.classList.remove('show');
            setTimeout(() => {
                resultContainer.classList.add('show');
            }, 10);
            
            // Scroll to result
            setTimeout(() => {
                resultContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 500);
            
            // Show success message
            alert('Your compatibility test has been recorded!');
        });
        
        // Share buttons
        document.getElementById('shareWhatsapp').addEventListener('click', function() {
            const score = document.getElementById('resultPercentage').textContent;
            const message = document.getElementById('resultMessage').textContent;
            const text = `My SBJIT engineering love score is ${score}! ${message} Check out your compatibility at SBJIT Valentine's 2026!`;
            const encodedText = encodeURIComponent(text);
            window.open(`https://wa.me/?text=${encodedText}`, '_blank');
        });
        
        document.getElementById('shareInstagram').addEventListener('click', function() {
            const score = document.getElementById('resultPercentage').textContent;
            const text = `My SBJIT engineering love score is ${score}! ðŸ’™ðŸ’› #SBJITValentine #EngineeringCrush`;
            alert('Take a screenshot and share on Instagram with #SBJITValentine!');
        });
        
        // Auto-save form data as user types (optional)
        document.querySelectorAll('#calculator input, #calculator select').forEach(element => {
            element.addEventListener('change', function() {
                // This could be extended to save partial form data
                console.log('Form field changed:', this.id, this.value);
            });
        });
        
        // Log initial page load
        console.log('SBJIT Valentine Platform Loaded with Backend Connection');
        console.log('Backend URL:', BACKEND_URL);
    });
</script>
